@model TeacherPortalViewModel
@{
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
    ViewData["Title"] = "Achievement Management";
}
<link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.0/datatables.min.css" />
<div class="mt-3">
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex align-items-center gap-2">
            <h5 class="mb-0">Achievements</h5>
            <div class="ms-auto d-flex align-items-center gap-2">
                <button id="btnToggleFilters" class="btn btn-outline-secondary btn-sm" type="button" aria-pressed="false"><i class="bi bi-funnel me-1"></i>Filters</button>
                @* <button id="btnBulkDelete" class="btn btn-danger btn-sm"><i class="bi bi-trash me-1"></i>Bulk Delete</button>
                <button id="btnAddAch" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>Add Achievement</button> *@
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="achievementsTable" class="table table-striped table-hover align-middle" width="100%">
                    <thead class="table-light">
                        <tr>
                           @*  <th style="width:26px;"><input type="checkbox" id="selectAllRows"></th> *@
                            @* <th style="width:40px;"></th> *@
                            <th>Code</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Icon</th>
                            <th>Rarity</th>
                            <th>Category</th>
                            <th>Status</th>
                        </tr>
                        <tr class="filters-row d-none">
                           @*  <th></th> *@
                            @* <th></th> *@
                            <th><input id="filterCode" class="form-control form-control-sm" placeholder="Code" /></th>
                            <th><input id="filterName" class="form-control form-control-sm" placeholder="Name" /></th>
                            <th><input id="filterDesc" class="form-control form-control-sm" placeholder="Desc" /></th>
                            <th><input id="filterIcon" class="form-control form-control-sm" placeholder="Icon" /></th>
                            <th><input id="filterRarity" class="form-control form-control-sm" placeholder="Rarity" /></th>
                            <th><input id="filterCategory" class="form-control form-control-sm" placeholder="Category" /></th>
                            <th>
                                <select id="filterStatus" class="form-select form-select-sm">
                                    <option value="">All</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="modalAddAch" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add Achievement</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formAddAch">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Code</label><input id="addCode" class="form-control" maxlength="80" required /></div>
            <div class="col-md-8"><label class="form-label">Name</label><input id="addName" class="form-control" maxlength="120" required /></div>
            <div class="col-md-12"><label class="form-label">Description</label><textarea id="addDescription" class="form-control" maxlength="300"></textarea></div>
            <div class="col-md-3"><label class="form-label">Icon</label><input id="addIcon" class="form-control" maxlength="40" placeholder="emoji or short" /></div>
            <div class="col-md-3"><label class="form-label">Rarity</label><input id="addRarity" class="form-control" maxlength="20" /></div>
            <div class="col-md-3"><label class="form-label">Category</label><input id="addCategory" class="form-control" maxlength="40" /></div>
            <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input class="form-check-input" type="checkbox" id="addIsActive" checked><label class="form-check-label" for="addIsActive">Active</label></div></div>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="btnSaveAddAch" class="btn btn-primary">Save</button></div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="modalEditAch" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Achievement</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formEditAch">
          <input type="hidden" id="editId" />
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Code</label><input id="editCode" class="form-control" maxlength="80" required /></div>
            <div class="col-md-8"><label class="form-label">Name</label><input id="editName" class="form-control" maxlength="120" required /></div>
            <div class="col-md-12"><label class="form-label">Description</label><textarea id="editDescription" class="form-control" maxlength="300"></textarea></div>
            <div class="col-md-3"><label class="form-label">Icon</label><input id="editIcon" class="form-control" maxlength="40" /></div>
            <div class="col-md-3"><label class="form-label">Rarity</label><input id="editRarity" class="form-control" maxlength="20" /></div>
            <div class="col-md-3"><label class="form-label">Category</label><input id="editCategory" class="form-control" maxlength="40" /></div>
            <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input class="form-check-input" type="checkbox" id="editIsActive"><label class="form-check-label" for="editIsActive">Active</label></div></div>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="btnSaveEditAch" class="btn btn-primary">Save Changes</button></div>
    </div>
  </div>
</div>

@section Scripts {
<script src="https://cdn.datatables.net/v/bs5/dt-2.0.0/datatables.min.js"></script>
<script>
(function(){
  window.applyDataTablesDefaults && window.applyDataTablesDefaults();
  const table = new DataTable('#achievementsTable', {
    ajax: { url: '@Url.Action("List","AchievementManagement")', dataSrc: 'data' },
    pageLength: 10,
    columns: [
      // { data: null, orderable:false, className:'text-center', render: (_, __, row)=>`<input type="checkbox" class="row-select" data-id="${row.id}">` },
      // { data: null, orderable:false, className:'text-start', render: renderActions },
      { data: 'code' },
      { data: 'name' },
      { data: 'description', render: v => v || '' },
      { data: 'icon', render: v => v? `<span>${v}</span>`:'' },
      { data: 'rarity', render: v => v||'' },
      { data: 'category', render: v => v||'' },
      { data: 'isActive', render: v => v?'<span class="badge bg-success">Active</span>':'<span class="badge bg-secondary">Inactive</span>' }
    ]
  });

  function renderActions(_, __, row){
    return `<div class="dropdown">
  <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">Actions</button>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="#" data-action="edit" data-id="${row.id}"><i class="bi bi-pencil-square me-1"></i>Edit</a></li>
    <li><a class="dropdown-item text-danger" href="#" data-action="delete" data-id="${row.id}"><i class="bi bi-trash me-1"></i>Delete</a></li>
  </ul>
</div>`;
  }

  // Inline filters
  const filterCode = document.getElementById('filterCode');
  const filterName = document.getElementById('filterName');
  const filterDesc = document.getElementById('filterDesc');
  const filterIcon = document.getElementById('filterIcon');
  const filterRarity = document.getElementById('filterRarity');
  const filterCategory = document.getElementById('filterCategory');
  const filterStatus = document.getElementById('filterStatus');
  const filtersRow = document.querySelector('#achievementsTable thead tr.filters-row');
  const toggleBtn = document.getElementById('btnToggleFilters');

  function norm(v){return (v||'').toString().toLowerCase();}
  DataTable.ext.search.push(function(settings,data,dataIndex){
    if(settings.nTable !== document.getElementById('achievementsTable')) return true;
    const row = table.row(dataIndex).data()||{};
    if(filterCode.value && !norm(row.code).includes(norm(filterCode.value))) return false;
    if(filterName.value && !norm(row.name).includes(norm(filterName.value))) return false;
    if(filterDesc.value && !norm(row.description).includes(norm(filterDesc.value))) return false;
    if(filterIcon.value && !norm(row.icon).includes(norm(filterIcon.value))) return false;
    if(filterRarity.value && !norm(row.rarity).includes(norm(filterRarity.value))) return false;
    if(filterCategory.value && !norm(row.category).includes(norm(filterCategory.value))) return false;
    if(filterStatus.value){
      const st = row.isActive? 'active':'inactive';
      if(st !== filterStatus.value) return false;
    }
    return true;
  });

  ['input','change'].forEach(evt=>{
    [filterCode, filterName, filterDesc, filterIcon, filterRarity, filterCategory, filterStatus].forEach(el=> el.addEventListener(evt, ()=> table.draw()));
  });

  function setFiltersVisible(show){
    if(show){ filtersRow.classList.remove('d-none'); toggleBtn.classList.add('active'); toggleBtn.setAttribute('aria-pressed','true'); }
    else { filtersRow.classList.add('d-none'); toggleBtn.classList.remove('active'); toggleBtn.setAttribute('aria-pressed','false'); }
    try{ localStorage.setItem('achievements_filters_visible', show? '1':'0'); }catch{}
  }
  toggleBtn.addEventListener('click', ()=> setFiltersVisible(filtersRow.classList.contains('d-none')) );
  const saved = (typeof localStorage !== 'undefined')? localStorage.getItem('achievements_filters_visible'):null;
  setFiltersVisible(saved==='1');

  // Selection helpers
  const selectAll = document.getElementById('selectAllRows');
  selectAll.addEventListener('change', ()=>{
    document.querySelectorAll('#achievementsTable tbody input.row-select').forEach(cb=>{ cb.checked = selectAll.checked; });
  });
  function getSelectedIds(){
    return Array.from(document.querySelectorAll('#achievementsTable tbody input.row-select:checked')).map(x=>x.getAttribute('data-id'));
  }

  // Row actions with precheck
  document.getElementById('achievementsTable').addEventListener('click', async e => {
    const a = e.target.closest('a[data-action]');
    if(!a) return; e.preventDefault();
    const action = a.getAttribute('data-action');
    const row = table.row(a.closest('tr')).data();
    if(!row) return;
    if(action==='edit') openEdit(row);
    if(action==='delete') {
      const check = await fetch('@Url.Action("CanDelete","AchievementManagement")', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids: [row.id] }) });
      const cj = await check.json().catch(()=>({}));
      if(!check.ok){ alert(cj.message || 'Unable to check dependencies.'); return; }
      if((cj.inUse||[]).length){
        const reason = cj.inUse[0]?.reason || 'Record is in use by related data.';
        alert(reason);
        return;
      }
      const res = await fetch('@Url.Action("Delete","AchievementManagement")?id='+row.id,{method:'DELETE'});
      if(res.ok) table.ajax.reload(null,false); else { const err = await res.json().catch(()=>({})); alert(err.message||'Delete failed'); }
    }
  });

  // Bulk delete with pre-check
  document.getElementById('btnBulkDelete').addEventListener('click', async ()=>{
    const ids = getSelectedIds();
    if(ids.length===0){ alert('Select at least one achievement.'); return; }
    try{
      const check = await fetch('@Url.Action("CanDelete","AchievementManagement")', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids }) });
      const cj = await check.json().catch(()=>({}));
      if(!check.ok){ alert(cj.message || 'Unable to check dependencies.'); return; }
      const blocked = (cj.inUse||[]);
      const allowed = (cj.ok||[]);
      if(allowed.length===0){
        const reasons = blocked.map(b=>`- ${b.id}: ${b.reason||'in use'}`).join('\n');
        alert('No deletions performed. Some items are in use:\n'+reasons);
        return;
      }
      const res = await fetch('@Url.Action("BulkDelete","AchievementManagement")',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids: allowed })
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok){ alert(j.message || 'Bulk delete failed.'); return; }
      let msg = `Deleted: ${j.deleted}`;
      if(blocked.length){ msg += `\nBlocked: ${blocked.length}`; }
      if(j.errors && j.errors.length){ msg += `\nErrors: ${j.errors.join(', ')}`; }
      alert(msg);
      selectAll.checked = false;
      table.ajax.reload(null,false);
    }catch{ alert('Bulk delete failed.'); }
  });

  document.getElementById('btnAddAch').addEventListener('click',()=>{ document.getElementById('formAddAch').reset(); addIsActive.checked = true; new bootstrap.Modal('#modalAddAch').show(); });

  document.getElementById('btnSaveAddAch').addEventListener('click', async ()=>{
    const payload={ code:addCode.value.trim(), name:addName.value.trim(), description:addDescription.value.trim(), icon:addIcon.value.trim(), rarity:addRarity.value.trim(), category:addCategory.value.trim(), isActive:addIsActive.checked };
    if(!payload.code || !payload.name) return alert('Code and Name required');
    const res = await fetch('@Url.Action("Create","AchievementManagement")',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(res.ok){ bootstrap.Modal.getInstance(document.getElementById('modalAddAch')).hide(); table.ajax.reload(null,false);} else { const err= await res.json().catch(()=>({})); alert(err.message||'Create failed'); }
  });

  function openEdit(row){
    editId.value=row.id; editCode.value=row.code; editName.value=row.name; editDescription.value=row.description||''; editIcon.value=row.icon||''; editRarity.value=row.rarity||''; editCategory.value=row.category||''; editIsActive.checked=!!row.isActive; new bootstrap.Modal('#modalEditAch').show();
  }

  document.getElementById('btnSaveEditAch').addEventListener('click', async ()=>{
    const payload={ id: editId.value, code: editCode.value.trim(), name: editName.value.trim(), description: editDescription.value.trim(), icon: editIcon.value.trim(), rarity: editRarity.value.trim(), category: editCategory.value.trim(), isActive: editIsActive.checked };
    if(!payload.id || !payload.code || !payload.name) return alert('Missing fields');
    const res = await fetch('@Url.Action("Update","AchievementManagement")',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(res.ok){ bootstrap.Modal.getInstance(document.getElementById('modalEditAch')).hide(); table.ajax.reload(null,false);} else { const err= await res.json().catch(()=>({})); alert(err.message||'Update failed'); }
  });
})();
</script>
}
